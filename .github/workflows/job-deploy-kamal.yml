name: job-deploy-kamal.yml

on:
  workflow_call:
    inputs:
      kamal-destination:
        description: Kamal destination to deploy to
        required: true
        type: string
    secrets:
      KAMAL_REGISTRY_PASSWORD:
        required: true
      SSH_PRIVATE_KEY:
        required: true
      APP_ENV:
        required: true
      APP_KEY:
        required: true
      DB_HOST:
        required: true
      DB_PORT:
        required: true
      DB_DATABASE:
        required: true
      DB_USERNAME:
        required: true
      DB_PASSWORD:
        required: true

env:
  DOCKER_BUILDKIT: 1
  KAMAL_REGISTRY_PASSWORD: ${{ secrets.KAMAL_REGISTRY_PASSWORD }}
  APP_ENV: ${{ secrets.APP_ENV }}
  APP_KEY: ${{ secrets.APP_KEY }}
  DB_HOST: ${{ secrets.DB_HOST }}
  DB_PORT: ${{ secrets.DB_PORT }}
  DB_DATABASE: ${{ secrets.DB_DATABASE }}
  DB_USERNAME: ${{ secrets.DB_USERNAME }}
  DB_PASSWORD: ${{ secrets.DB_PASSWORD }}

jobs:
  deploy:
    name: kamal deploy
    runs-on: ubuntu-latest

    steps:
      - name: Checkout
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Set up Ruby
        uses: ruby/setup-ruby@v1
        with:
          ruby-version: 3.4.5
          bundler-cache: true

      - name: Install Kamal
        run: |
          gem install specific_install
          gem specific_install https://github.com/basecamp/kamal.git v2.7.0

      - name: Set up SSH agent
        uses: webfactory/ssh-agent@v0.9.0
        with:
          ssh-private-key: ${{ secrets.SSH_PRIVATE_KEY }}

      - name: Set up Docker Buildx
        id: buildx
        uses: docker/setup-buildx-action@v3

      - name: Expose GitHub Runtime for cache
        uses: crazy-max/ghaction-github-runtime@v3

      - name: Log in to Docker registry
        uses: docker/login-action@v3
        with:
          username: mohamedbenaisha
          password: ${{ secrets.KAMAL_REGISTRY_PASSWORD }}

      - name: Set image tag
        run: |
          echo "IMAGE=mohamedbenaisha/radiusfusion" >> "$GITHUB_ENV"
          echo "IMAGE_TAG=${GITHUB_SHA}" >> "$GITHUB_ENV"

      - name: Build and push (with GHA cache)
        uses: docker/build-push-action@v6
        with:
          context: .
          file: docker/Dockerfile
          platforms: linux/amd64
          builder: ${{ steps.buildx.outputs.name }}
          push: true
          tags: |
            ${{ env.IMAGE }}:latest
            ${{ env.IMAGE }}:${{ env.IMAGE_TAG }}
          labels: |
            service=radiusfusion
          cache-from: type=gha
          cache-to: type=gha,mode=max

      - name: Acquire Kamal deploy lock
        run: kamal lock release -d ${{ inputs.kamal-destination }}

      - name: Deploy with Kamal
        run: kamal deploy --skip-push -d ${{ inputs.kamal-destination }}
